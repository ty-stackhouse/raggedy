name: AI Developer (Headless)

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:

permissions:
  contents: write       # Needed to commit code
  issues: write         # Needed to edit labels
  pull-requests: write  # Needed to create PRs

jobs:
  process-task:
    runs-on: ubuntu-latest
    concurrency: 
      group: ai-dev-queue
      cancel-in-progress: false

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      - name: Install OpenAI Library
        run: pip install openai



      - name: Pick a Task (Oldest 'ai:todo')
        id: pick_task
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/scripts/pick_task.sh
          .github/scripts/pick_task.sh

      - name: Run Agent (OpenRouter)
        if: steps.pick_task.outputs.has_task == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TASK_PAYLOAD: ${{ steps.pick_task.outputs.task_prompt }}
        run: |
          # Runs the agent script which writes solution.json directly
          python .github/scripts/run_agent.py
          
          # Verify the file was created and show a sample
          if [ -f solution.json ]; then
            echo "✓ solution.json created successfully"
            head -c 200 solution.json && echo ""
          else
            echo "ERROR: solution.json was not created!"
            exit 1
          fi

      - name: Validate Agent Output
        if: steps.pick_task.outputs.has_task == 'true'
        run: |
          # Check if solution.json exists
          if [ ! -f solution.json ]; then
            echo "ERROR: solution.json was not created by the agent!"
            exit 1
          fi

          # Validate it's valid JSON
          if ! jq empty solution.json 2>/dev/null; then
            echo "ERROR: solution.json is not valid JSON!"
            echo "Contents:"
            cat solution.json
            exit 1
          fi

          # Check required fields
          for field in branch_name commit_message pr_title pr_body files; do
            if ! jq -e ".$field" solution.json > /dev/null; then
              echo "ERROR: Missing required field '$field' in solution.json"
              exit 1
            fi
          done

          echo "✓ solution.json is valid and contains all required fields"

      - name: Apply Changes & Create PR
        if: steps.pick_task.outputs.has_task == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.pick_task.outputs.issue_number }}
        run: |
          # Use external script to apply solution (parsing and file writes)
          python .github/scripts/apply_solution.py solution.json "$ISSUE_NUM"

