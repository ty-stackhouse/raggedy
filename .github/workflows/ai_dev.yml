name: AI Developer (Headless)

on:
  schedule:
    # Runs at 14:00 UTC (8:00 AM CST) every day
    - cron: "0 14 * * *"
  workflow_dispatch:
    # Allows you to click "Run workflow" manually from GitHub Actions tab

permissions:
  contents: write       # Needed to commit code
  issues: write         # Needed to edit labels
  pull-requests: write  # Needed to create PRs

jobs:
  process-task:
    runs-on: ubuntu-latest
    concurrency: 
      group: ai-dev-queue
      cancel-in-progress: false

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      - name: Install OpenAI Library
        run: pip install openai



      - name: Pick a Task (Oldest 'ai:todo')
        id: pick_task
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Prefer existing 'ai:in-progress' issues, otherwise pick from 'ai:todo'
          IN_NUM=$(gh issue list --label "ai:in-progress" --state open --limit 1 --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$IN_NUM" ]; then
            ISSUE_NUMBER="$IN_NUM"
            SELECTED_LABEL="ai:in-progress"
          else
            TODO_NUM=$(gh issue list --label "ai:todo" --state open --limit 1 --json number --jq '.[0].number' 2>/dev/null || echo "")
            if [ -z "$TODO_NUM" ]; then
              echo "No tasks found. Exiting."
              echo "has_task=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            ISSUE_NUMBER="$TODO_NUM"
            SELECTED_LABEL="ai:todo"
          fi

          # 2. Fetch issue details (title/body) via gh to avoid jq dependency
          ISSUE_TITLE=$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title' 2>/dev/null || echo "")
          ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body' 2>/dev/null || echo "")

          echo "Found Issue #$ISSUE_NUMBER (label: $SELECTED_LABEL): $ISSUE_TITLE"

          # 4. Ensure the 'ai:in-progress' label exists (create if missing)
          if ! gh label list --limit 100 --json name | jq -r '.[].name' | grep -xq "ai:in-progress"; then
            gh label create "ai:in-progress" --color 1D76DB --description "In progress (claimed by AI)"
          fi

          # Export which label we selected for debugging/conditional logic
          echo "selected_label=$SELECTED_LABEL" >> $GITHUB_OUTPUT

          # If we picked an 'ai:todo' item, claim it by adding ai:in-progress and removing ai:todo.
          if [ "$SELECTED_LABEL" = "ai:todo" ]; then
            gh issue edit "$ISSUE_NUMBER" --add-label "ai:in-progress" --remove-label "ai:todo"
          else
            # Ensure it's tagged as in-progress (idempotent)
            gh issue edit "$ISSUE_NUMBER" --add-label "ai:in-progress"
          fi
          
          # 5. Export variables for next steps
          echo "has_task=true" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # 6. Prepare prompt string (Context + Task)
          # Clean inputs to prevent JSON breaking in shell
          CLEAN_TITLE=$(echo "$ISSUE_TITLE")
          CLEAN_BODY=$(echo "$ISSUE_BODY")
          
          # Capture file tree (ignoring .git and hidden files)
          FILE_TREE=$(find . -maxdepth 3 -not -path '*/.*')
          
          # Create a safe multi-line environment variable
          {
            echo "task_prompt<<EOF"
            echo "REPO CONTEXT (File Tree):"
            echo "$FILE_TREE"
            echo ""
            echo "TASK TITLE: $CLEAN_TITLE"
            echo "TASK DESCRIPTION:"
            echo "$CLEAN_BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Run Agent (OpenRouter)
        if: steps.pick_task.outputs.has_task == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TASK_PAYLOAD: ${{ steps.pick_task.outputs.task_prompt }}
        run: |
          # Runs the agent script which writes solution.json directly
          python .github/scripts/run_agent.py
          
          # Verify the file was created and show a sample
          if [ -f solution.json ]; then
            echo "✓ solution.json created successfully"
            head -c 200 solution.json && echo ""
          else
            echo "ERROR: solution.json was not created!"
            exit 1
          fi

      - name: Validate Agent Output
        if: steps.pick_task.outputs.has_task == 'true'
        run: |
          # Check if solution.json exists
          if [ ! -f solution.json ]; then
            echo "ERROR: solution.json was not created by the agent!"
            exit 1
          fi

          # Validate it's valid JSON
          if ! jq empty solution.json 2>/dev/null; then
            echo "ERROR: solution.json is not valid JSON!"
            echo "Contents:"
            cat solution.json
            exit 1
          fi

          # Check required fields
          for field in branch_name commit_message pr_title pr_body files; do
            if ! jq -e ".$field" solution.json > /dev/null; then
              echo "ERROR: Missing required field '$field' in solution.json"
              exit 1
            fi
          done

          echo "✓ solution.json is valid and contains all required fields"

      - name: Apply Changes & Create PR
        if: steps.pick_task.outputs.has_task == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.pick_task.outputs.issue_number }}
        run: |
          # Use external script to apply solution (parsing and file writes)
          python .github/scripts/apply_solution.py solution.json "$ISSUE_NUM"

